package transactions

import (
	"github.com/ledgerwatch/erigon-lib/common"
	"github.com/ledgerwatch/erigon-lib/common/hexutil"
	"github.com/ledgerwatch/erigon-lib/common/hexutility"
	"github.com/ledgerwatch/erigon/accounts/abi"
	"github.com/ledgerwatch/erigon/turbo/adapter/ethapi"
	"strings"
)

var (
	_jsondata = `
[
	{
		"inputs": [
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "_decodeBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			}
		],
		"name": "balance",
		"outputs": [
			{
				"internalType": "bool[]",
				"name": "",
				"type": "bool[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			},
			{
				"internalType": "address[][]",
				"name": "users",
				"type": "address[][]"
			}
		],
		"name": "tokenBalance",
		"outputs": [
			{
				"internalType": "uint256[][]",
				"name": "",
				"type": "uint256[][]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			}
		],
		"name": "tokenInfo",
		"outputs": [
			{
				"internalType": "bytes[]",
				"name": "",
				"type": "bytes[]"
			},
			{
				"internalType": "bytes[]",
				"name": "",
				"type": "bytes[]"
			},
			{
				"internalType": "bytes[]",
				"name": "",
				"type": "bytes[]"
			},
			{
				"internalType": "bytes[]",
				"name": "",
				"type": "bytes[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
`
	_deployCode          = "0x608060405234801561001057600080fd5b506004361061004c5760003560e01c806328523bc3146100515780636f28a81214610081578063cadda4ba146100b4578063dfca5f24146100e4575b600080fd5b61006b60048036038101906100669190610f39565b610114565b604051610078919061131e565b60405180910390f35b61009b60048036038101906100969190610ef8565b610455565b6040516100ab9493929190611362565b60405180910390f35b6100ce60048036038101906100c99190610ef8565b610bcb565b6040516100db9190611340565b60405180910390f35b6100fe60048036038101906100f99190610fa5565b610d66565b60405161010b91906113e5565b60405180910390f35b606080835167ffffffffffffffff8111801561012f57600080fd5b5060405190808252806020026020018201604052801561016357816020015b606081526020019060019003908161014e5790505b50905060005b845181101561044a57606084828151811061018057fe5b602002602001015190506060815167ffffffffffffffff811180156101a457600080fd5b506040519080825280602002602001820160405280156101d35781602001602082028036833780820191505090505b50905060005b825181101561042257600060608986815181106101f257fe5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1685848151811061021c57fe5b60200260200101516040516024016102349190611303565b6040516020818303038152906040527f70a08231000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516102be91906112ec565b600060405180830381855afa9150503d80600081146102f9576040519150601f19603f3d011682016040523d82523d6000602084013e6102fe565b606091505b509150915081156103f85760008151141561033257600084848151811061032157fe5b6020026020010181815250506103f3565b3073ffffffffffffffffffffffffffffffffffffffff1663dfca5f24826040518263ffffffff1660e01b815260040161036b91906113c3565b60206040518083038186803b15801561038357600080fd5b505afa9250505080156103b457506040513d601f19601f820116820180604052508101906103b19190610fe6565b60015b6103d75760008484815181106103c657fe5b6020026020010181815250506103f2565b808585815181106103e457fe5b602002602001018181525050505b5b610413565b600084848151811061040657fe5b6020026020010181815250505b505080806001019150506101d9565b508084848151811061043057fe5b602002602001018190525050508080600101915050610169565b508091505092915050565b6060806060806060855167ffffffffffffffff8111801561047557600080fd5b506040519080825280602002602001820160405280156104a957816020015b60608152602001906001900390816104945790505b5090506060865167ffffffffffffffff811180156104c657600080fd5b506040519080825280602002602001820160405280156104fa57816020015b60608152602001906001900390816104e55790505b5090506060875167ffffffffffffffff8111801561051757600080fd5b5060405190808252806020026020018201604052801561054b57816020015b60608152602001906001900390816105365790505b5090506060885167ffffffffffffffff8111801561056857600080fd5b5060405190808252806020026020018201604052801561059c57816020015b60608152602001906001900390816105875790505b5090506000606060005b8b51811015610bb15760008c82815181106105bd57fe5b602002602001015190508073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f06fdde03000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161066e91906112ec565b600060405180830381855afa9150503d80600081146106a9576040519150601f19603f3d011682016040523d82523d6000602084013e6106ae565b606091505b50809450819550505083156106da57828883815181106106ca57fe5b602002602001018190525061073e565b600067ffffffffffffffff811180156106f257600080fd5b506040519080825280601f01601f1916602001820160405280156107255781602001600182028036833780820191505090505b5088838151811061073257fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f95d89b41000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516107e591906112ec565b600060405180830381855afa9150503d8060008114610820576040519150601f19603f3d011682016040523d82523d6000602084013e610825565b606091505b5080945081955050508315610851578287838151811061084157fe5b60200260200101819052506108b5565b600067ffffffffffffffff8111801561086957600080fd5b506040519080825280601f01601f19166020018201604052801561089c5781602001600182028036833780820191505090505b508783815181106108a957fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f313ce567000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161095c91906112ec565b600060405180830381855afa9150503d8060008114610997576040519150601f19603f3d011682016040523d82523d6000602084013e61099c565b606091505b50809450819550505083156109c857828683815181106109b857fe5b6020026020010181905250610a2c565b600067ffffffffffffffff811180156109e057600080fd5b506040519080825280601f01601f191660200182016040528015610a135781602001600182028036833780820191505090505b50868381518110610a2057fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f18160ddd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610ad391906112ec565b600060405180830381855afa9150503d8060008114610b0e576040519150601f19603f3d011682016040523d82523d6000602084013e610b13565b606091505b5080945081955050508315610b3f5782858381518110610b2f57fe5b6020026020010181905250610ba3565b600067ffffffffffffffff81118015610b5757600080fd5b506040519080825280601f01601f191660200182016040528015610b8a5781602001600182028036833780820191505090505b50858381518110610b9757fe5b60200260200101819052505b5080806001019150506105a6565b508585858599509950995099505050505050509193509193565b606080825167ffffffffffffffff81118015610be657600080fd5b50604051908082528060200260200182016040528015610c155781602001602082028036833780820191505090505b50905060005b8351811015610d5c576000848281518110610c3257fe5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1630604051602401610c619190611303565b6040516020818303038152906040527f70a08231000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610ceb91906112ec565b600060405180830381855afa9150503d8060008114610d26576040519150601f19603f3d011682016040523d82523d6000602084013e610d2b565b606091505b5050905080838381518110610d3c57fe5b602002602001019015159081151581525050508080600101915050610c1b565b5080915050919050565b600081806020019051810190610d7c9190610fe6565b9050919050565b600081359050610d9281611660565b92915050565b600082601f830112610da957600080fd5b8135610dbc610db78261142d565b611400565b91508181835260208401935060208101905083856020840282011115610de157600080fd5b60005b83811015610e115781610df78882610d83565b845260208401935060208301925050600181019050610de4565b5050505092915050565b600082601f830112610e2c57600080fd5b8135610e3f610e3a82611455565b611400565b9150818183526020840193506020810190508360005b83811015610e855781358601610e6b8882610d98565b845260208401935060208301925050600181019050610e55565b5050505092915050565b600082601f830112610ea057600080fd5b8135610eb3610eae8261147d565b611400565b91508082526020830160208301858383011115610ecf57600080fd5b610eda83828461160d565b50505092915050565b600081519050610ef281611677565b92915050565b600060208284031215610f0a57600080fd5b600082013567ffffffffffffffff811115610f2457600080fd5b610f3084828501610d98565b91505092915050565b60008060408385031215610f4c57600080fd5b600083013567ffffffffffffffff811115610f6657600080fd5b610f7285828601610d98565b925050602083013567ffffffffffffffff811115610f8f57600080fd5b610f9b85828601610e1b565b9150509250929050565b600060208284031215610fb757600080fd5b600082013567ffffffffffffffff811115610fd157600080fd5b610fdd84828501610e8f565b91505092915050565b600060208284031215610ff857600080fd5b600061100684828501610ee3565b91505092915050565b600061101b83836111be565b905092915050565b600061102f838361121c565b60208301905092915050565b6000611047838361122b565b905092915050565b600061105b83836112ce565b60208301905092915050565b611070816115c5565b82525050565b6000611081826114e9565b61108b8185611554565b93508360208202850161109d856114a9565b8060005b858110156110d957848403895281516110ba858261100f565b94506110c583611520565b925060208a019950506001810190506110a1565b50829750879550505050505092915050565b60006110f6826114f4565b6111008185611565565b935061110b836114b9565b8060005b8381101561113c5781516111238882611023565b975061112e8361152d565b92505060018101905061110f565b5085935050505092915050565b6000611154826114ff565b61115e8185611576565b935083602082028501611170856114c9565b8060005b858110156111ac578484038952815161118d858261103b565b94506111988361153a565b925060208a01995050600181019050611174565b50829750879550505050505092915050565b60006111c98261150a565b6111d38185611587565b93506111de836114d9565b8060005b8381101561120f5781516111f6888261104f565b975061120183611547565b9250506001810190506111e2565b5085935050505092915050565b611225816115d7565b82525050565b600061123682611515565b6112408185611598565b935061125081856020860161161c565b6112598161164f565b840191505092915050565b600061126f82611515565b61127981856115a9565b935061128981856020860161161c565b6112928161164f565b840191505092915050565b60006112a882611515565b6112b281856115ba565b93506112c281856020860161161c565b80840191505092915050565b6112d781611603565b82525050565b6112e681611603565b82525050565b60006112f8828461129d565b915081905092915050565b60006020820190506113186000830184611067565b92915050565b600060208201905081810360008301526113388184611076565b905092915050565b6000602082019050818103600083015261135a81846110eb565b905092915050565b6000608082019050818103600083015261137c8187611149565b905081810360208301526113908186611149565b905081810360408301526113a48185611149565b905081810360608301526113b88184611149565b905095945050505050565b600060208201905081810360008301526113dd8184611264565b905092915050565b60006020820190506113fa60008301846112dd565b92915050565b6000604051905081810181811067ffffffffffffffff8211171561142357600080fd5b8060405250919050565b600067ffffffffffffffff82111561144457600080fd5b602082029050602081019050919050565b600067ffffffffffffffff82111561146c57600080fd5b602082029050602081019050919050565b600067ffffffffffffffff82111561149457600080fd5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600081905092915050565b60006115d0826115e3565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b60005b8381101561163a57808201518184015260208101905061161f565b83811115611649576000848401525b50505050565b6000601f19601f8301169050919050565b611669816115c5565b811461167457600080fd5b50565b61168081611603565b811461168b57600080fd5b5056fea264697066735822122008f31f7bb742618ed734d3ae59f73643d67f177d65a8b8b2e4ada5db847e7b5c64736f6c634300060c0033"
	TokenContractCaller  = common.HexToAddress("0x1992111111111111111111111111111111111110")
	TokenContractAddress = common.HexToAddress("0x1992111111111111111111111111111111111111")
)

type TokenContract struct {
	caller  common.Address
	address common.Address
	code    []byte
	abi     abi.ABI
}

func NewTokenContract() TokenContract {
	_abi, _ := abi.JSON(strings.NewReader(_jsondata))
	return TokenContract{
		caller:  TokenContractCaller,
		address: TokenContractAddress,
		code:    hexutil.MustDecode(_deployCode),
		abi:     _abi,
	}
}

func (tc *TokenContract) Override() *ethapi.StateOverrides {
	return &ethapi.StateOverrides{
		tc.address: ethapi.Account{
			Nonce:     nil,
			Code:      (*hexutility.Bytes)(&tc.code),
			Balance:   nil,
			State:     nil,
			StateDiff: nil,
		},
	}
}
