package transactions

import (
	"github.com/ledgerwatch/erigon-lib/common"
	"github.com/ledgerwatch/erigon-lib/common/hexutil"
	"github.com/ledgerwatch/erigon-lib/common/hexutility"
	"github.com/ledgerwatch/erigon/accounts/abi"
	"github.com/ledgerwatch/erigon/turbo/adapter/ethapi"
	"strings"
)

var (
	_jsondata = `
[
	{
		"inputs": [
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "_decodeBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			}
		],
		"name": "balance",
		"outputs": [
			{
				"internalType": "bool[]",
				"name": "",
				"type": "bool[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			},
			{
				"internalType": "address[][]",
				"name": "users",
				"type": "address[][]"
			}
		],
		"name": "tokenBalance",
		"outputs": [
			{
				"internalType": "uint256[][]",
				"name": "",
				"type": "uint256[][]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			}
		],
		"name": "tokenInfo",
		"outputs": [
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			},
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			},
			{
				"internalType": "bytes[]",
				"name": "",
				"type": "bytes[]"
			},
			{
				"internalType": "bytes[]",
				"name": "",
				"type": "bytes[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
`
	_deployCode          = "0x608060405234801561001057600080fd5b506004361061004c5760003560e01c806328523bc3146100515780636f28a81214610081578063cadda4ba146100b4578063dfca5f24146100e4575b600080fd5b61006b60048036038101906100669190611158565b610114565b6040516100789190611640565b60405180910390f35b61009b60048036038101906100969190611117565b610455565b6040516100ab9493929190611684565b60405180910390f35b6100ce60048036038101906100c99190611117565b610c68565b6040516100db9190611662565b60405180910390f35b6100fe60048036038101906100f991906111c4565b610e03565b60405161010b9190611707565b60405180910390f35b606080835167ffffffffffffffff8111801561012f57600080fd5b5060405190808252806020026020018201604052801561016357816020015b606081526020019060019003908161014e5790505b50905060005b845181101561044a57606084828151811061018057fe5b602002602001015190506060815167ffffffffffffffff811180156101a457600080fd5b506040519080825280602002602001820160405280156101d35781602001602082028036833780820191505090505b50905060005b825181101561042257600060608986815181106101f257fe5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1685848151811061021c57fe5b60200260200101516040516024016102349190611625565b6040516020818303038152906040527f70a08231000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516102be919061160e565b600060405180830381855afa9150503d80600081146102f9576040519150601f19603f3d011682016040523d82523d6000602084013e6102fe565b606091505b509150915081156103f85760008151141561033257600084848151811061032157fe5b6020026020010181815250506103f3565b3073ffffffffffffffffffffffffffffffffffffffff1663dfca5f24826040518263ffffffff1660e01b815260040161036b91906116e5565b60206040518083038186803b15801561038357600080fd5b505afa9250505080156103b457506040513d601f19601f820116820180604052508101906103b19190611246565b60015b6103d75760008484815181106103c657fe5b6020026020010181815250506103f2565b808585815181106103e457fe5b602002602001018181525050505b5b610413565b600084848151811061040657fe5b6020026020010181815250505b505080806001019150506101d9565b508084848151811061043057fe5b602002602001018190525050508080600101915050610169565b508091505092915050565b6060806060806060855167ffffffffffffffff8111801561047557600080fd5b506040519080825280602002602001820160405280156104a957816020015b60608152602001906001900390816104945790505b5090506060865167ffffffffffffffff811180156104c657600080fd5b506040519080825280602002602001820160405280156104fa57816020015b60608152602001906001900390816104e55790505b5090506060875167ffffffffffffffff8111801561051757600080fd5b5060405190808252806020026020018201604052801561054b57816020015b60608152602001906001900390816105365790505b5090506060885167ffffffffffffffff8111801561056857600080fd5b5060405190808252806020026020018201604052801561059c57816020015b60608152602001906001900390816105875790505b5090506000606060005b8b51811015610c4e5760008c82815181106105bd57fe5b602002602001015190508073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f06fdde03000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161066e919061160e565b600060405180830381855afa9150503d80600081146106a9576040519150601f19603f3d011682016040523d82523d6000602084013e6106ae565b606091505b508094508195505050831561075e576020835114156106f6576000602084015190506106d981610e20565b8984815181106106e557fe5b602002602001018190525050610759565b60208351111561073057828060200190518101906107149190611205565b88838151811061072057fe5b6020026020010181905250610758565b6040518060200160405280600081525088838151811061074c57fe5b60200260200101819052505b5b610786565b6040518060200160405280600081525088838151811061077a57fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f95d89b41000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161082d919061160e565b600060405180830381855afa9150503d8060008114610868576040519150601f19603f3d011682016040523d82523d6000602084013e61086d565b606091505b508094508195505050831561092a576020835114156108c25782604051602001610897919061160e565b6040516020818303038152906040528783815181106108b257fe5b6020026020010181905250610925565b6020835111156108fc57828060200190518101906108e09190611205565b8783815181106108ec57fe5b6020026020010181905250610924565b6040518060200160405280600081525087838151811061091857fe5b60200260200101819052505b5b610952565b6040518060200160405280600081525087838151811061094657fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f313ce567000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516109f9919061160e565b600060405180830381855afa9150503d8060008114610a34576040519150601f19603f3d011682016040523d82523d6000602084013e610a39565b606091505b5080945081955050508315610a655782868381518110610a5557fe5b6020026020010181905250610ac9565b600067ffffffffffffffff81118015610a7d57600080fd5b506040519080825280601f01601f191660200182016040528015610ab05781602001600182028036833780820191505090505b50868381518110610abd57fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f18160ddd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610b70919061160e565b600060405180830381855afa9150503d8060008114610bab576040519150601f19603f3d011682016040523d82523d6000602084013e610bb0565b606091505b5080945081955050508315610bdc5782858381518110610bcc57fe5b6020026020010181905250610c40565b600067ffffffffffffffff81118015610bf457600080fd5b506040519080825280601f01601f191660200182016040528015610c275781602001600182028036833780820191505090505b50858381518110610c3457fe5b60200260200101819052505b5080806001019150506105a6565b508585858599509950995099505050505050509193509193565b606080825167ffffffffffffffff81118015610c8357600080fd5b50604051908082528060200260200182016040528015610cb25781602001602082028036833780820191505090505b50905060005b8351811015610df9576000848281518110610ccf57fe5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1630604051602401610cfe9190611625565b6040516020818303038152906040527f70a08231000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610d88919061160e565b600060405180830381855afa9150503d8060008114610dc3576040519150601f19603f3d011682016040523d82523d6000602084013e610dc8565b606091505b5050905080838381518110610dd957fe5b602002602001019015159081151581525050508080600101915050610cb8565b5080915050919050565b600081806020019051810190610e199190611246565b9050919050565b606060005b60208160ff16108015610e705750600060f81b838260ff1660208110610e4757fe5b1a60f81b7effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614155b15610e82578080600101915050610e25565b60608160ff1667ffffffffffffffff81118015610e9e57600080fd5b506040519080825280601f01601f191660200182016040528015610ed15781602001600182028036833780820191505090505b50905060005b8260ff168160ff161015610f4357848160ff1660208110610ef457fe5b1a60f81b828260ff1681518110610f0757fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050610ed7565b508092505050919050565b600081359050610f5d81611a03565b92915050565b600082601f830112610f7457600080fd5b8135610f87610f828261174f565b611722565b91508181835260208401935060208101905083856020840282011115610fac57600080fd5b60005b83811015610fdc5781610fc28882610f4e565b845260208401935060208301925050600181019050610faf565b5050505092915050565b600082601f830112610ff757600080fd5b813561100a61100582611777565b611722565b9150818183526020840193506020810190508360005b8381101561105057813586016110368882610f63565b845260208401935060208301925050600181019050611020565b5050505092915050565b600082601f83011261106b57600080fd5b813561107e6110798261179f565b611722565b9150808252602083016020830185838301111561109a57600080fd5b6110a58382846119b0565b50505092915050565b600082601f8301126110bf57600080fd5b81516110d26110cd826117cb565b611722565b915080825260208301602083018583830111156110ee57600080fd5b6110f98382846119bf565b50505092915050565b60008151905061111181611a1a565b92915050565b60006020828403121561112957600080fd5b600082013567ffffffffffffffff81111561114357600080fd5b61114f84828501610f63565b91505092915050565b6000806040838503121561116b57600080fd5b600083013567ffffffffffffffff81111561118557600080fd5b61119185828601610f63565b925050602083013567ffffffffffffffff8111156111ae57600080fd5b6111ba85828601610fe6565b9150509250929050565b6000602082840312156111d657600080fd5b600082013567ffffffffffffffff8111156111f057600080fd5b6111fc8482850161105a565b91505092915050565b60006020828403121561121757600080fd5b600082015167ffffffffffffffff81111561123157600080fd5b61123d848285016110ae565b91505092915050565b60006020828403121561125857600080fd5b600061126684828501611102565b91505092915050565b600061127b83836114a7565b905092915050565b600061128f8383611505565b60208301905092915050565b60006112a78383611514565b905092915050565b60006112bb83836115b7565b905092915050565b60006112cf83836115f0565b60208301905092915050565b6112e481611968565b82525050565b60006112f582611847565b6112ff81856118d5565b935083602082028501611311856117f7565b8060005b8581101561134d578484038952815161132e858261126f565b945061133983611894565b925060208a01995050600181019050611315565b50829750879550505050505092915050565b600061136a82611852565b61137481856118e6565b935061137f83611807565b8060005b838110156113b05781516113978882611283565b97506113a2836118a1565b925050600181019050611383565b5085935050505092915050565b60006113c88261185d565b6113d281856118f7565b9350836020820285016113e485611817565b8060005b858110156114205784840389528151611401858261129b565b945061140c836118ae565b925060208a019950506001810190506113e8565b50829750879550505050505092915050565b600061143d82611868565b6114478185611908565b93508360208202850161145985611827565b8060005b85811015611495578484038952815161147685826112af565b9450611481836118bb565b925060208a0199505060018101905061145d565b50829750879550505050505092915050565b60006114b282611873565b6114bc8185611919565b93506114c783611837565b8060005b838110156114f85781516114df88826112c3565b97506114ea836118c8565b9250506001810190506114cb565b5085935050505092915050565b61150e8161197a565b82525050565b600061151f8261187e565b611529818561192a565b93506115398185602086016119bf565b611542816119f2565b840191505092915050565b60006115588261187e565b611562818561193b565b93506115728185602086016119bf565b61157b816119f2565b840191505092915050565b60006115918261187e565b61159b818561194c565b93506115ab8185602086016119bf565b80840191505092915050565b60006115c282611889565b6115cc8185611957565b93506115dc8185602086016119bf565b6115e5816119f2565b840191505092915050565b6115f9816119a6565b82525050565b611608816119a6565b82525050565b600061161a8284611586565b915081905092915050565b600060208201905061163a60008301846112db565b92915050565b6000602082019050818103600083015261165a81846112ea565b905092915050565b6000602082019050818103600083015261167c818461135f565b905092915050565b6000608082019050818103600083015261169e8187611432565b905081810360208301526116b28186611432565b905081810360408301526116c681856113bd565b905081810360608301526116da81846113bd565b905095945050505050565b600060208201905081810360008301526116ff818461154d565b905092915050565b600060208201905061171c60008301846115ff565b92915050565b6000604051905081810181811067ffffffffffffffff8211171561174557600080fd5b8060405250919050565b600067ffffffffffffffff82111561176657600080fd5b602082029050602081019050919050565b600067ffffffffffffffff82111561178e57600080fd5b602082029050602081019050919050565b600067ffffffffffffffff8211156117b657600080fd5b601f19601f8301169050602081019050919050565b600067ffffffffffffffff8211156117e257600080fd5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600081905092915050565b600082825260208201905092915050565b600061197382611986565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b60005b838110156119dd5780820151818401526020810190506119c2565b838111156119ec576000848401525b50505050565b6000601f19601f8301169050919050565b611a0c81611968565b8114611a1757600080fd5b50565b611a23816119a6565b8114611a2e57600080fd5b5056fea2646970667358221220522754fbdaa33ffe88df885eba1966de59fbc8d088245bf10335a345b57d307064736f6c634300060c0033"
	TokenContractCaller  = common.HexToAddress("0x1992111111111111111111111111111111111110")
	TokenContractAddress = common.HexToAddress("0x1992111111111111111111111111111111111111")
)

type TokenContract struct {
	caller  common.Address
	address common.Address
	code    []byte
	abi     abi.ABI
}

func NewTokenContract() TokenContract {
	_abi, _ := abi.JSON(strings.NewReader(_jsondata))
	return TokenContract{
		caller:  TokenContractCaller,
		address: TokenContractAddress,
		code:    hexutil.MustDecode(_deployCode),
		abi:     _abi,
	}
}

func (tc *TokenContract) Override() *ethapi.StateOverrides {
	return &ethapi.StateOverrides{
		tc.address: ethapi.Account{
			Nonce:     nil,
			Code:      (*hexutility.Bytes)(&tc.code),
			Balance:   nil,
			State:     nil,
			StateDiff: nil,
		},
	}
}
