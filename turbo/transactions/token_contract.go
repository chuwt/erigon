package transactions

import (
	"github.com/ledgerwatch/erigon-lib/common"
	"github.com/ledgerwatch/erigon-lib/common/hexutil"
	"github.com/ledgerwatch/erigon-lib/common/hexutility"
	"github.com/ledgerwatch/erigon/accounts/abi"
	"github.com/ledgerwatch/erigon/turbo/adapter/ethapi"
	"strings"
)

var (
	_jsondata = `
[
	{
		"inputs": [
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "_decodeBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			}
		],
		"name": "balance",
		"outputs": [
			{
				"internalType": "bool[]",
				"name": "",
				"type": "bool[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			},
			{
				"internalType": "address[][]",
				"name": "users",
				"type": "address[][]"
			}
		],
		"name": "tokenBalance",
		"outputs": [
			{
				"internalType": "uint256[][]",
				"name": "",
				"type": "uint256[][]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address[]",
				"name": "tokens",
				"type": "address[]"
			}
		],
		"name": "tokenInfo",
		"outputs": [
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			},
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			},
			{
				"internalType": "bytes[]",
				"name": "",
				"type": "bytes[]"
			},
			{
				"internalType": "bytes[]",
				"name": "",
				"type": "bytes[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
`
	_deployCode          = "0x608060405234801561001057600080fd5b506004361061004c5760003560e01c806328523bc3146100515780636f28a81214610081578063cadda4ba146100b4578063dfca5f24146100e4575b600080fd5b61006b6004803603810190610066919061114b565b610114565b6040516100789190611633565b60405180910390f35b61009b6004803603810190610096919061110a565b610455565b6040516100ab9493929190611677565b60405180910390f35b6100ce60048036038101906100c9919061110a565b610c5b565b6040516100db9190611655565b60405180910390f35b6100fe60048036038101906100f991906111b7565b610df6565b60405161010b91906116fa565b60405180910390f35b606080835167ffffffffffffffff8111801561012f57600080fd5b5060405190808252806020026020018201604052801561016357816020015b606081526020019060019003908161014e5790505b50905060005b845181101561044a57606084828151811061018057fe5b602002602001015190506060815167ffffffffffffffff811180156101a457600080fd5b506040519080825280602002602001820160405280156101d35781602001602082028036833780820191505090505b50905060005b825181101561042257600060608986815181106101f257fe5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1685848151811061021c57fe5b60200260200101516040516024016102349190611618565b6040516020818303038152906040527f70a08231000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516102be9190611601565b600060405180830381855afa9150503d80600081146102f9576040519150601f19603f3d011682016040523d82523d6000602084013e6102fe565b606091505b509150915081156103f85760008151141561033257600084848151811061032157fe5b6020026020010181815250506103f3565b3073ffffffffffffffffffffffffffffffffffffffff1663dfca5f24826040518263ffffffff1660e01b815260040161036b91906116d8565b60206040518083038186803b15801561038357600080fd5b505afa9250505080156103b457506040513d601f19601f820116820180604052508101906103b19190611239565b60015b6103d75760008484815181106103c657fe5b6020026020010181815250506103f2565b808585815181106103e457fe5b602002602001018181525050505b5b610413565b600084848151811061040657fe5b6020026020010181815250505b505080806001019150506101d9565b508084848151811061043057fe5b602002602001018190525050508080600101915050610169565b508091505092915050565b6060806060806060855167ffffffffffffffff8111801561047557600080fd5b506040519080825280602002602001820160405280156104a957816020015b60608152602001906001900390816104945790505b5090506060865167ffffffffffffffff811180156104c657600080fd5b506040519080825280602002602001820160405280156104fa57816020015b60608152602001906001900390816104e55790505b5090506060875167ffffffffffffffff8111801561051757600080fd5b5060405190808252806020026020018201604052801561054b57816020015b60608152602001906001900390816105365790505b5090506060885167ffffffffffffffff8111801561056857600080fd5b5060405190808252806020026020018201604052801561059c57816020015b60608152602001906001900390816105875790505b5090506000606060005b8b51811015610c415760008c82815181106105bd57fe5b602002602001015190508073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f06fdde03000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161066e9190611601565b600060405180830381855afa9150503d80600081146106a9576040519150601f19603f3d011682016040523d82523d6000602084013e6106ae565b606091505b508094508195505050831561075e576020835114156106f6576000602084015190506106d981610e13565b8984815181106106e557fe5b602002602001018190525050610759565b602083511115610730578280602001905181019061071491906111f8565b88838151811061072057fe5b6020026020010181905250610758565b6040518060200160405280600081525088838151811061074c57fe5b60200260200101819052505b5b610786565b6040518060200160405280600081525088838151811061077a57fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f95d89b41000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161082d9190611601565b600060405180830381855afa9150503d8060008114610868576040519150601f19603f3d011682016040523d82523d6000602084013e61086d565b606091505b508094508195505050831561091d576020835114156108b55760006020840151905061089881610e13565b8884815181106108a457fe5b602002602001018190525050610918565b6020835111156108ef57828060200190518101906108d391906111f8565b8783815181106108df57fe5b6020026020010181905250610917565b6040518060200160405280600081525087838151811061090b57fe5b60200260200101819052505b5b610945565b6040518060200160405280600081525087838151811061093957fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f313ce567000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516109ec9190611601565b600060405180830381855afa9150503d8060008114610a27576040519150601f19603f3d011682016040523d82523d6000602084013e610a2c565b606091505b5080945081955050508315610a585782868381518110610a4857fe5b6020026020010181905250610abc565b600067ffffffffffffffff81118015610a7057600080fd5b506040519080825280601f01601f191660200182016040528015610aa35781602001600182028036833780820191505090505b50868381518110610ab057fe5b60200260200101819052505b8073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f18160ddd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610b639190611601565b600060405180830381855afa9150503d8060008114610b9e576040519150601f19603f3d011682016040523d82523d6000602084013e610ba3565b606091505b5080945081955050508315610bcf5782858381518110610bbf57fe5b6020026020010181905250610c33565b600067ffffffffffffffff81118015610be757600080fd5b506040519080825280601f01601f191660200182016040528015610c1a5781602001600182028036833780820191505090505b50858381518110610c2757fe5b60200260200101819052505b5080806001019150506105a6565b508585858599509950995099505050505050509193509193565b606080825167ffffffffffffffff81118015610c7657600080fd5b50604051908082528060200260200182016040528015610ca55781602001602082028036833780820191505090505b50905060005b8351811015610dec576000848281518110610cc257fe5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1630604051602401610cf19190611618565b6040516020818303038152906040527f70a08231000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610d7b9190611601565b600060405180830381855afa9150503d8060008114610db6576040519150601f19603f3d011682016040523d82523d6000602084013e610dbb565b606091505b5050905080838381518110610dcc57fe5b602002602001019015159081151581525050508080600101915050610cab565b5080915050919050565b600081806020019051810190610e0c9190611239565b9050919050565b606060005b60208160ff16108015610e635750600060f81b838260ff1660208110610e3a57fe5b1a60f81b7effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614155b15610e75578080600101915050610e18565b60608160ff1667ffffffffffffffff81118015610e9157600080fd5b506040519080825280601f01601f191660200182016040528015610ec45781602001600182028036833780820191505090505b50905060005b8260ff168160ff161015610f3657848160ff1660208110610ee757fe5b1a60f81b828260ff1681518110610efa57fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050610eca565b508092505050919050565b600081359050610f50816119f6565b92915050565b600082601f830112610f6757600080fd5b8135610f7a610f7582611742565b611715565b91508181835260208401935060208101905083856020840282011115610f9f57600080fd5b60005b83811015610fcf5781610fb58882610f41565b845260208401935060208301925050600181019050610fa2565b5050505092915050565b600082601f830112610fea57600080fd5b8135610ffd610ff88261176a565b611715565b9150818183526020840193506020810190508360005b8381101561104357813586016110298882610f56565b845260208401935060208301925050600181019050611013565b5050505092915050565b600082601f83011261105e57600080fd5b813561107161106c82611792565b611715565b9150808252602083016020830185838301111561108d57600080fd5b6110988382846119a3565b50505092915050565b600082601f8301126110b257600080fd5b81516110c56110c0826117be565b611715565b915080825260208301602083018583830111156110e157600080fd5b6110ec8382846119b2565b50505092915050565b60008151905061110481611a0d565b92915050565b60006020828403121561111c57600080fd5b600082013567ffffffffffffffff81111561113657600080fd5b61114284828501610f56565b91505092915050565b6000806040838503121561115e57600080fd5b600083013567ffffffffffffffff81111561117857600080fd5b61118485828601610f56565b925050602083013567ffffffffffffffff8111156111a157600080fd5b6111ad85828601610fd9565b9150509250929050565b6000602082840312156111c957600080fd5b600082013567ffffffffffffffff8111156111e357600080fd5b6111ef8482850161104d565b91505092915050565b60006020828403121561120a57600080fd5b600082015167ffffffffffffffff81111561122457600080fd5b611230848285016110a1565b91505092915050565b60006020828403121561124b57600080fd5b6000611259848285016110f5565b91505092915050565b600061126e838361149a565b905092915050565b600061128283836114f8565b60208301905092915050565b600061129a8383611507565b905092915050565b60006112ae83836115aa565b905092915050565b60006112c283836115e3565b60208301905092915050565b6112d78161195b565b82525050565b60006112e88261183a565b6112f281856118c8565b935083602082028501611304856117ea565b8060005b8581101561134057848403895281516113218582611262565b945061132c83611887565b925060208a01995050600181019050611308565b50829750879550505050505092915050565b600061135d82611845565b61136781856118d9565b9350611372836117fa565b8060005b838110156113a357815161138a8882611276565b975061139583611894565b925050600181019050611376565b5085935050505092915050565b60006113bb82611850565b6113c581856118ea565b9350836020820285016113d78561180a565b8060005b8581101561141357848403895281516113f4858261128e565b94506113ff836118a1565b925060208a019950506001810190506113db565b50829750879550505050505092915050565b60006114308261185b565b61143a81856118fb565b93508360208202850161144c8561181a565b8060005b85811015611488578484038952815161146985826112a2565b9450611474836118ae565b925060208a01995050600181019050611450565b50829750879550505050505092915050565b60006114a582611866565b6114af818561190c565b93506114ba8361182a565b8060005b838110156114eb5781516114d288826112b6565b97506114dd836118bb565b9250506001810190506114be565b5085935050505092915050565b6115018161196d565b82525050565b600061151282611871565b61151c818561191d565b935061152c8185602086016119b2565b611535816119e5565b840191505092915050565b600061154b82611871565b611555818561192e565b93506115658185602086016119b2565b61156e816119e5565b840191505092915050565b600061158482611871565b61158e818561193f565b935061159e8185602086016119b2565b80840191505092915050565b60006115b58261187c565b6115bf818561194a565b93506115cf8185602086016119b2565b6115d8816119e5565b840191505092915050565b6115ec81611999565b82525050565b6115fb81611999565b82525050565b600061160d8284611579565b915081905092915050565b600060208201905061162d60008301846112ce565b92915050565b6000602082019050818103600083015261164d81846112dd565b905092915050565b6000602082019050818103600083015261166f8184611352565b905092915050565b600060808201905081810360008301526116918187611425565b905081810360208301526116a58186611425565b905081810360408301526116b981856113b0565b905081810360608301526116cd81846113b0565b905095945050505050565b600060208201905081810360008301526116f28184611540565b905092915050565b600060208201905061170f60008301846115f2565b92915050565b6000604051905081810181811067ffffffffffffffff8211171561173857600080fd5b8060405250919050565b600067ffffffffffffffff82111561175957600080fd5b602082029050602081019050919050565b600067ffffffffffffffff82111561178157600080fd5b602082029050602081019050919050565b600067ffffffffffffffff8211156117a957600080fd5b601f19601f8301169050602081019050919050565b600067ffffffffffffffff8211156117d557600080fd5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600081905092915050565b600082825260208201905092915050565b600061196682611979565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b60005b838110156119d05780820151818401526020810190506119b5565b838111156119df576000848401525b50505050565b6000601f19601f8301169050919050565b6119ff8161195b565b8114611a0a57600080fd5b50565b611a1681611999565b8114611a2157600080fd5b5056fea264697066735822122032bd8e5751d41acdb21ee42c618cb8abc4b982429e5b5f9711569d45c04aeace64736f6c634300060c0033"
	TokenContractCaller  = common.HexToAddress("0x1992111111111111111111111111111111111110")
	TokenContractAddress = common.HexToAddress("0x1992111111111111111111111111111111111111")
)

type TokenContract struct {
	caller  common.Address
	address common.Address
	code    []byte
	abi     abi.ABI
}

func NewTokenContract() TokenContract {
	_abi, _ := abi.JSON(strings.NewReader(_jsondata))
	return TokenContract{
		caller:  TokenContractCaller,
		address: TokenContractAddress,
		code:    hexutil.MustDecode(_deployCode),
		abi:     _abi,
	}
}

func (tc *TokenContract) Override() *ethapi.StateOverrides {
	return &ethapi.StateOverrides{
		tc.address: ethapi.Account{
			Nonce:     nil,
			Code:      (*hexutility.Bytes)(&tc.code),
			Balance:   nil,
			State:     nil,
			StateDiff: nil,
		},
	}
}
